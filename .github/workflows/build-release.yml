name: Build Release

on:
  workflow_dispatch:
    inputs:
      notes:
        description: "Release notes (optional)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      version: ${{ steps.tag.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force
          latest=$(git tag -l "v[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | head -n 1)
          if [ -z "$latest" ]; then
            base="0.0.0"
          else
            base="${latest#v}"
          fi
          next=$(BASE="$base" node -e "const parts=process.env.BASE.split('.').map(n=>parseInt(n,10)||0);parts[2]+=1;console.log(parts.join('.'));")
          echo "version=$next" >> "$GITHUB_OUTPUT"
          echo "tag=v$next" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          body: ${{ inputs.notes }}
          generate_release_notes: true

  build-desktop:
    runs-on: ${{ matrix.os }}
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Cache Electron artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
            ~/Library/Caches/electron
            ~/Library/Caches/electron-builder
            C:\Users\runneradmin\AppData\Local\electron\Cache
            C:\Users\runneradmin\AppData\Local\electron-builder\Cache
          key: ${{ runner.os }}-electron-${{ hashFiles('**/package-lock.json') }}

      - name: Install
        run: npm ci --production=false

      - name: Set desktop version
        shell: bash
        run: |
          node -e "const fs=require('fs');const path='apps/desktop/package.json';const data=JSON.parse(fs.readFileSync(path,'utf8'));data.version=process.env.VERSION;fs.writeFileSync(path,JSON.stringify(data,null,2)+'\n');"
        env:
          VERSION: ${{ needs.prepare.outputs.version }}

      - name: Build desktop
        run: npm run -w @openvisionmatrix/desktop build

      - name: Remove builder debug artifact
        run: node -e "const fs=require('fs');const p='apps/desktop/release/builder-debug.yml';if(fs.existsSync(p)) fs.rmSync(p);"

      - name: VirusTotal scan
        shell: bash
        env:
          VIRUSTOTAL_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
        run: |
          set -uo pipefail
          if [ -z "${VIRUSTOTAL_API_KEY}" ]; then
            echo "VirusTotal API key not set; skipping scan."
            exit 0
          fi
          shopt -s nullglob
          files=(apps/desktop/release/*.exe apps/desktop/release/*.AppImage apps/desktop/release/*.dmg)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No release artifacts found for VirusTotal."
            exit 0
          fi
          max_bytes=$((650 * 1024 * 1024))
          for file in "${files[@]}"; do
            size=$(wc -c < "$file")
            if [ "$size" -gt "$max_bytes" ]; then
              echo "Skipping $file (size ${size} bytes exceeds VirusTotal limit)"
              continue
            fi
            echo "Uploading $file to VirusTotal"
            response=$(curl -sS -X POST "https://www.virustotal.com/api/v3/files" \
              -H "x-apikey: ${VIRUSTOTAL_API_KEY}" \
              -F "file=@${file}" || true)
            if [ -z "$response" ]; then
              echo "VirusTotal upload failed for $file"
              continue
            fi
            analysis_id=$(node -e "let data='';process.stdin.on('data',c=>data+=c);process.stdin.on('end',()=>{try{const json=JSON.parse(data);console.log(json.data?.id??'');}catch(_){console.log('');}});" <<< "$response")
            if [ -n "$analysis_id" ]; then
              echo "VirusTotal analysis: https://www.virustotal.com/gui/analysis/$analysis_id"
            else
              echo "VirusTotal response: $response"
            fi
          done

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          files: apps/desktop/release/*
          fail_on_unmatched_files: true
